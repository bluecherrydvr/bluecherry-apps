#!/usr/bin/make -f

VERSION := $(shell dpkg-parsechangelog | sed '/^Version:/!d;s/^[^ ]* //')
DB_VERSION := $(shell cat misc/sql/installed_db_version)

LD_LIBRARY_PATH+=:stage/lib

%:
	dh --parallel $@

.PHONY: override_dh_strip

override_dh_strip:
	dh_strip --dbg-package=bluecherry-dbg

override_dh_installinit: sbin-start=$(wildcard /sbin/start)
override_dh_installinit:
	dh_installinit $(if $(sbin-start),--name=bluecherry)

override_dh_installlogrotate:
	dh_installlogrotate

# all things common for deb and rpm make in scripts like post_make_install.sh
# and call it from deb and rpm packages
override_dh_auto_install:
	dh_auto_install --destdir=debian/bluecherry
	scripts/build_helper/post_make_install.sh deb ./ debian/bluecherry "$(VERSION)"

override_dh_installdeb:
	echo "#!/bin/bash -e" > debian/bluecherry.preinst
	cat misc/sql/load_db_creds.sh >> debian/bluecherry.preinst
	sed \
		-e "s/%%CURRENT_VERSION%%/${VERSION}/" \
		-e "s/%%CURRENT_DB_VERSION%%/${DB_VERSION}/" \
		debian/bluecherry.preinst.template >> debian/bluecherry.preinst
	dh_installdeb
	-rm ${CURDIR}/debian/bluecherry/DEBIAN/conffiles

override_dh_shlibdeps:
	echo "override_dh_shlibdeps: PWD is $(shell readlink -f . )"
	dh_shlibdeps -l$(shell readlink -f .)/debian/bluecherry/usr/lib/bluecherry/

override_dh_usrlocal:
	true
