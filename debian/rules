#!/usr/bin/make -f

VERSION := $(shell dpkg-parsechangelog | sed '/^Version:/!d;s/^[^ ]* //')

LD_LIBRARY_PATH+=:stage/lib

%:
	dh --parallel $@

.PHONY: override_dh_strip

override_dh_strip:
	dh_strip --dbg-package=bluecherry-dbg

override_dh_installinit: sbin-start=$(wildcard /sbin/start)
override_dh_installinit:
	dh_installinit $(if $(sbin-start),--name=bluecherry)

override_dh_installlogrotate:
	dh_installlogrotate

override_dh_auto_install:
	dh_auto_install --destdir=debian/bluecherry
	cp -a misc/sql/* debian/bluecherry/usr/share/bluecherry/
	cp misc/remove_untracked_media_files.sh debian/bluecherry/usr/share/bluecherry/
	cp misc/backup_db.sh debian/bluecherry/usr/share/bluecherry/
	cp misc/list_ether.sh debian/bluecherry/usr/share/bluecherry/
	cp -a misc/ponvif* debian/bluecherry/usr/share/bluecherry/
	rm -rf debian/bluecherry/usr/share/bluecherry/ponvif*/.git
	mkdir debian/bluecherry/DEBIAN
	cp debian/templates debian/bluecherry/DEBIAN/ # TODO How to simplify this?
	install -m640 -g www-data -D debian/bluecherry.conf.in \
		debian/bluecherry/usr/share/bluecherry/bluecherry.conf.in
	install -m644 -D debian/apache.conf \
		debian/bluecherry/etc/apache2/sites-available/bluecherry.conf
	install -m644 debian/bluecherry.monit \
		debian/bluecherry/etc/monit/conf.d/bluecherry
#	install -m644 debian/bluecherry.apparmor \
#		debian/bluecherry/etc/apparmor.d/usr.sbin.bc-server
	mkdir debian/bluecherry/etc/cron.d
	cp debian/bluecherry.cron debian/bluecherry/etc/cron.d/bluecherry
	cp -a www/* debian/bluecherry/usr/share/bluecherry/www
	echo "$(VERSION)" > debian/bluecherry/usr/share/bluecherry/version

override_dh_installdeb:
	sed "s/%%CURRENT_VERSION%%/${VERSION}/" debian/bluecherry.preinst.template > debian/bluecherry.preinst
	dh_installdeb
	-rm ${CURDIR}/debian/bluecherry/DEBIAN/conffiles

override_dh_shlibdeps:
	echo "override_dh_shlibdeps: PWD is $(shell readlink -f . )"
	dh_shlibdeps -l$(shell readlink -f .)/debian/bluecherry/usr/lib/bluecherry/

override_dh_usrlocal:
	true
